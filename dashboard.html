<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>üîê NIDS ‚Ä¢ Real-time Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark shadow">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">üîê NIDS ‚Äî Real-time Intrusion Detection</span>
      <a href="/offline" class="btn btn-outline-light">üìÇ Offline Analysis</a>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Counters -->
    <div class="row mb-4 text-center">
      <div class="col-md-4">
        <div class="card glass shadow">
          <div class="card-body">
            <h5>Total Packets</h5>
            <div id="total" class="counter">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card glass shadow">
          <div class="card-body">
            <h5>Normal</h5>
            <div id="normal" class="counter text-success">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card glass shadow">
          <div class="card-body">
            <h5>Attacks</h5>
            <div id="attacks" class="counter text-danger">0</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card glass shadow mb-4">
      <div class="card-body">
        <h5>üö® Live Attack Alerts</h5>
        <div id="alerts" class="alert-box"></div>
      </div>
    </div>

    <div class="card glass shadow">
      <div class="card-body">
        <h5>Live Packet Feed</h5>
        <div class="table-wrapper">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Source</th>
                <th>Destination</th>
                <th>Sport</th>
                <th>Dport</th>
                <th>Protocol</th>
                <th>Length</th>
                <th>Prediction</th>
                <th>Probability</th>
                <th>Remedy</th>
              </tr>
            </thead>
            <tbody id="packetTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="remedyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content glass">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title">Confirm Remedy Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="remedyText"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <button type="button" class="btn btn-danger" id="confirmRemedy">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedAction = null;
    let selectedTarget = null;

    async function fetchData() {
      const res = await fetch('/data');
      const data = await res.json();

      // Update counters
      document.getElementById('total').textContent = data.stats.total;
      document.getElementById('normal').textContent = data.stats.normal;
      document.getElementById('attacks').textContent = data.stats.attacks;

      // Update alerts
      const alerts = document.getElementById('alerts');
      alerts.innerHTML = '';
      data.packets.forEach(pkt => {
        if (pkt.label === "Attack") {
          const alert = document.createElement("div");
          alert.className = "alert alert-danger py-1 mb-2";
          alert.innerHTML = `<strong>üö® Attack!</strong> ${pkt.src} ‚Üí ${pkt.dst} | Prob: ${(pkt.prob * 100).toFixed(1)}%`;
          alerts.prepend(alert);
        }
      });

      // Update packet table
      const table = document.getElementById('packetTable');
      table.innerHTML = '';
      data.packets.forEach(pkt => {
        const row = `<tr>
          <td>${pkt.src}</td>
          <td>${pkt.dst}</td>
          <td>${pkt.sport}</td>
          <td>${pkt.dport}</td>
          <td>${pkt.proto}</td>
          <td>${pkt.length}</td>
          <td class="${pkt.label === 'Attack' ? 'attack' : 'normal'}">${pkt.label}</td>
          <td>${(pkt.prob * 100).toFixed(1)}%</td>
          <td>${pkt.label === 'Attack'
              ? `<button class="btn btn-sm btn-warning" onclick="openRemedy('${pkt.src}', '${pkt.dport}')">Suggest Remedy</button>`
              : ''}</td>
        </tr>`;
        table.innerHTML += row;
      });
    }

    function openRemedy(ip, port) {
      selectedAction = "Block IP or Close Port";
      selectedTarget = `IP: ${ip}, Port: ${port}`;
      document.getElementById("remedyText").textContent =
        `Do you want to ${selectedAction} (${selectedTarget}) ?`;
      const modal = new bootstrap.Modal(document.getElementById("remedyModal"));
      modal.show();
    }

    document.getElementById("confirmRemedy").addEventListener("click", async () => {
      const res = await fetch("/remedy", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({action: selectedAction, target: selectedTarget})
      });
      const data = await res.json();
      alert(data.message);  // simulation message
      const modalEl = document.getElementById("remedyModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    });

    setInterval(fetchData, 2000); // refresh every 2s
  </script>
</body>
</html>
